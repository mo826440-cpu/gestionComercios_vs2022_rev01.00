@using Microsoft.AspNetCore.Components
@using Shared.Services
@inject IAuthService AuthService

@if (isAuthenticated)
{
    <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
    <FocusOnNavigate RouteData="@routeData" Selector="h1" />
}
else if (IsPublicPage())
{
    <RouteView RouteData="@routeData" DefaultLayout="@typeof(LoginLayout)" />
    <FocusOnNavigate RouteData="@routeData" Selector="h1" />
}
else
{
    <RedirectToLogin />
}

@code {
    [Parameter] public RouteData? routeData { get; set; }
    
    private bool isAuthenticated = false;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthentication();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Verificar autenticaci√≥n cada vez que cambia la ruta
        await CheckAuthentication();
        await base.OnParametersSetAsync();
    }

    private async Task CheckAuthentication()
    {
        isLoading = true;
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        isLoading = false;
        StateHasChanged();
    }

    private bool IsPublicPage()
    {
        var pageType = routeData?.PageType?.FullName ?? "";
        return pageType.Contains("Login") || 
               pageType.Contains("Landing") || 
               pageType.Contains("Registro");
    }
}
